# Pixel Electronics
## CSA and bandpass filter
A simplified schematic of the pixel electronics is shown below:

![Image title](./images/pixel_fe.png){width=100%}
/// caption
AstroPix CSA and bandpass filter
///

The sensing element is the pn-diode formed by the p-substrate and the deep n-well of the pixel. By applying a high reverse bias, a thick depletion region is created. Electrons generated by charged particles or photons in the depletion region are quickly transported to the collection n-well by drift, due to the strong electric field.\\
A \ac{csa} is capacitively coupled to the collection n-well, it is implemented as a cascode amplifier with a cascode load and an nfet input device. The feedback capacitance of around \SI{500}{\atto\F} is formed by the parasitic drain junction capacitance of the load cascode pfet. A voltage signal is produced dependent on the input charge and this capacitance. Assuming that the amplifier has a high open loop gain $A_{0}$ with $A_{O} C_{fb} >> C_{det}$ this can be simplified to:
$$
v_{out} \approx \dfrac{Q}{C_{fb}}
$$
A second, much larger \SI{15}{\femto\F} feedback capacitance C1 is connected from the amplifier input to the voltage node between the load transistors. If the cascode transistor is in saturation, the impedance from the output to this node is high, but if there is a large input signal, the cascoded transistor goes into the linear region and there is a low impedance path from the output to this node. Therefore for a large input signal the two capacitors appear to be in parallel resulting in a reduced closed-loop gain of:
$$
v_{out} \approx \dfrac{Q}{C_{fb}+C_{fb2}}
$$
The feedback capacitance is continuously discharged by a constant current source VNFB, which results in a linear decay of the output pulse.
The amplifiers input dc operating point is set by the source-follower SF1. The second source-follower SF2 acts as a low pass filter. Due to its non-linearity, the rising edge has a fast rise time, but the falling edge because the load current source INFOLL2 is biased with a low current. A higher current increases the low pass filter bandwidth, resulting in a steeper slope i.e. shorter ToT but also higher noise. From the output of SF2 the signal is capacitively coupled through a \ac{mim} capacitor to AmpOutAC. The dc level is set by the voltage DAC blpix, which is connected to the signal though a small current source, acting as a high pass filter together with the coupling capacitance.\\

## Comparator and Levelshifter
The signal path from the comparator input to the receiver output is shown below:
![Image title](./images/apix3_comp_rec.png){width=100%}
/// caption
AstroPix CSA and bandpass filter
///
The comparator is a two stage amplifier with the first stage being a nfet differential amplifier with a pmos current source and the second stage beeing a common-source amplifier to increase the gain.\\
The analog voltage pulse goes into the comparator and gets compared to the threshold voltage Vth. The comparator bias current is set by the \ac{dac} VNCOMP. The output is a positive voltage pulse with Vlow 0V and VHigh 1.8V.
Due to mismatch, the differential amplifier in the comparator is not totally symmetric. This results in a shift of the effective threshold to the value set by Vth. A compensation mechanism is implemented in \ap{4}. It consists of a 3bit current \ac{dac} which can be tuned to make the tail currents in the differential stage equal.\\
The following stage is an open drain nfet, pulled up by the current source VPREC. This nfet converts the positive pulse to a negative pulse. The source of the nfet is connected to Vminuspix(normally 0.7 - 1V), which reduces the signal amplitude from 1.8V to 0.8 - 1.1V. A higher signal amplitude, i.e. a lower value of vminuspix reduces the propagation delay but also increases EMI at the same time.\\
In the hit buffer of every pixel, the signal is converted back to the full amplitude by a pfet common-source amplifier. The output signal is a positive pulse with a fast rise time and a fall time which is determined by the discharge current VNREC.